<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>信任演化博弈系统 - 测试客户端</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1, h2 {
            color: #333;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .cooperate {
            background-color: #4CAF50;
            color: white;
        }
        .betray {
            background-color: #F44336;
            color: white;
        }
        .join {
            background-color: #2196F3;
            color: white;
        }
        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .connected {
            background-color: #E8F5E9;
            color: #4CAF50;
        }
        .disconnected {
            background-color: #FFEBEE;
            color: #F44336;
        }
        .history {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        .history-item {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .player-info {
            display: flex;
            justify-content: space-between;
        }
        .player-info div {
            flex: 1;
        }
        .reward-info {
            background: #E3F2FD;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .error {
            background-color: #FFEBEE;
            color: #D32F2F;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .login-form input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .login-form button {
            margin-top: 10px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            background: #f5f5f5;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            margin-right: 5px;
        }
        .tab.active {
            background: white;
            border: 1px solid #ddd;
            border-bottom: none;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .leaderboard {
            width: 100%;
            border-collapse: collapse;
        }
        .leaderboard th, .leaderboard td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .leaderboard th {
            background-color: #f5f5f5;
        }
        .player-id {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .connection-details {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .ping-info {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: 5px;
            font-size: 11px;
        }
        .ping-good {
            background-color: #E8F5E9;
            color: #4CAF50;
        }
        .ping-medium {
            background-color: #FFF3E0;
            color: #FF9800;
        }
        .ping-bad {
            background-color: #FFEBEE;
            color: #F44336;
        }
        .bar {
            display: inline-block;
            margin-right: 2px;
            background-color: #4CAF50;
            border-bottom-left-radius: 2px;
            border-bottom-right-radius: 2px;
        }
        .bar.betray {
            background-color: #F44336;
        }
        .opponent-analysis {
            background-color: #F9F9F9;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
        }
        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .analysis-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .analysis-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .analysis-value {
            font-size: 18px;
            font-weight: bold;
        }
        .trend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .trend-label {
            flex: 1;
        }
        .trend-bar-container {
            flex: 3;
            background-color: #f0f0f0;
            height: 15px;
            border-radius: 10px;
            overflow: hidden;
        }
        .trend-bar {
            height: 100%;
            background-color: #2196F3;
        }
        .color-cooperation {
            color: #4CAF50;
        }
        .color-betrayal {
            color: #F44336;
        }
    </style>
</head>
<body>
    <h1>信任演化博弈系统 - 测试客户端</h1>
    
    <div class="container">
        <h2>连接状态</h2>
        <div id="connection-status" class="status disconnected">未连接</div>
        <div id="connection-details" class="connection-details" style="display: none;">
            <p><strong>连接ID:</strong> <span id="connection-id">-</span></p>
            <p><strong>传输类型:</strong> <span id="transport-type">-</span></p>
            <p><strong>延迟:</strong> <span id="ping-time">-</span> <span id="ping-quality" class="ping-info">-</span></p>
            <p><strong>连接时间:</strong> <span id="connection-time">-</span></p>
        </div>
        <button id="connect-button" class="join">连接服务器</button>
        <div id="error-message" class="error" style="display: none;"></div>
    </div>
    
    <div id="login-container" class="container" style="display: none;">
        <h2>玩家信息</h2>
        <div class="login-form">
            <input type="text" id="player-name-input" placeholder="请输入您的名称（最多20个字符）" maxlength="20">
            <input type="text" id="player-id-input" placeholder="如需重连，请输入您的玩家ID（可留空）">
            <button id="login-button" class="join">登录/注册</button>
        </div>
    </div>
    
    <div id="game-container" style="display: none;">
        <div class="container">
            <h2>玩家信息</h2>
            <div class="player-info">
                <div>
                    <p><strong>玩家名称:</strong> <span id="player-name">-</span></p>
                    <p class="player-id"><strong>ID:</strong> <span id="player-id">-</span></p>
                    <p><strong>当前分数:</strong> <span id="player-score">-</span></p>
                    <p><strong>当前回合:</strong> <span id="current-round">-</span></p>
                    <p><strong>总游戏次数:</strong> <span id="total-games">-</span></p>
                </div>
                <div>
                    <p><strong>对手名称:</strong> <span id="opponent-name">无对手</span></p>
                    <p class="player-id"><strong>对手ID:</strong> <span id="opponent-id">-</span></p>
                    <p><strong>对局状态:</strong> <span id="game-status">未开始</span></p>
                </div>
            </div>
            
            <div class="reward-info">
                <p><strong>奖励机制:</strong></p>
                <ul>
                    <li>双方合作各得: <span id="both-cooperate">-</span> 分</li>
                    <li>双方背叛各得: <span id="both-betray">-</span> 分</li>
                    <li>合作方失去: <span id="cooperate">-</span> 分</li>
                    <li>背叛方得到: <span id="betray">-</span> 分</li>
                </ul>
            </div>
        </div>
        
        <div class="container">
            <div class="tabs">
                <div class="tab active" data-tab="game-tab">游戏</div>
                <div class="tab" data-tab="stats-tab">统计</div>
                <div class="tab" data-tab="leaderboard-tab">排行榜</div>
            </div>
            
            <div id="game-tab" class="tab-content active">
                <h2>游戏操作</h2>
                <button id="join-button" class="join">加入游戏</button>
                
                <div class="buttons">
                    <button id="cooperate-button" class="cooperate" disabled>选择合作</button>
                    <button id="betray-button" class="betray" disabled>选择背叛</button>
                </div>
                
                <div id="opponent-analysis" class="opponent-analysis" style="display: none;">
                    <h3>对手行为分析</h3>
                    <div class="analysis-grid">
                        <div class="analysis-item">
                            <div class="analysis-title">合作率</div>
                            <div id="cooperation-rate" class="analysis-value color-cooperation">-</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-title">背叛率</div>
                            <div id="betrayal-rate" class="analysis-value color-betrayal">-</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-title">连续合作最长</div>
                            <div id="max-cooperation-streak" class="analysis-value">-</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-title">连续背叛最长</div>
                            <div id="max-betrayal-streak" class="analysis-value">-</div>
                        </div>
                        <div class="analysis-item" style="grid-column: span 2;">
                            <div class="analysis-title">奖励机制趋势</div>
                            <div class="rewards-trend" style="display: flex; margin-top: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 12px; color: #666;">双方合作各得</div>
                                    <div id="reward-both-cooperate" class="analysis-value" style="font-size: 16px;">-</div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 12px; color: #666;">双方背叛各得</div>
                                    <div id="reward-both-betray" class="analysis-value" style="font-size: 16px;">-</div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 12px; color: #666;">合作方损失</div>
                                    <div id="reward-cooperate" class="analysis-value" style="font-size: 16px;">-</div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 12px; color: #666;">背叛方获得</div>
                                    <div id="reward-betray" class="analysis-value" style="font-size: 16px;">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 15px;">历史模式</h4>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <label style="margin-right: 10px;">
                                <input type="checkbox" id="detailed-history-toggle"> 显示详细历史（包含奖励机制）
                            </label>
                        </div>
                    </div>
                    
                    <!-- 添加详细历史表格，默认隐藏 -->
                    <div id="detailed-history-container" style="display: none; margin-top: 15px; max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background-color: #f5f5f5;">
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">轮次</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">选择</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">分数</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">合作各得</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">背叛各得</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">合作方损失</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">背叛方获得</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">时间</th>
                                </tr>
                            </thead>
                            <tbody id="detailed-history-body">
                                <!-- 历史记录将在这里动态填充 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 高级分析图表区域 -->
                    <div id="advanced-analysis" style="margin-top: 20px; display: none;">
                        <h4>奖励机制与选择关系分析</h4>
                        <div style="display: flex; justify-content: space-between; gap: 10px;">
                            <div style="flex: 1; background: white; border-radius: 4px; padding:.10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h5 style="margin-top: 0;">选择分布</h5>
                                <canvas id="choiceDistributionChart" height="200"></canvas>
                            </div>
                            <div style="flex: 1; background: white; border-radius: 4px; padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h5 style="margin-top: 0;">奖励机制变化</h5>
                                <canvas id="rewardsChangeChart" height="200"></canvas>
                            </div>
                        </div>
                        <div style="background: white; border-radius: 4px; padding: 10px; margin-top: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <h5 style="margin-top: 0;">奖励比例与选择关系</h5>
                            <canvas id="rewardsRatioChart" height="150"></canvas>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 15px;">行为趋势</h4>
                    <div class="trend-item">
                        <div class="trend-label">对手合作后继续合作</div>
                        <div class="trend-bar-container">
                            <div id="trend-cc" class="trend-bar" style="width: 0%"></div>
                        </div>
                        <div id="trend-cc-value" style="margin-left: 8px;">0%</div>
                    </div>
                    <div class="trend-item">
                        <div class="trend-label">对手背叛后改为合作</div>
                        <div class="trend-bar-container">
                            <div id="trend-bc" class="trend-bar" style="width: 0%"></div>
                        </div>
                        <div id="trend-bc-value" style="margin-left: 8px;">0%</div>
                    </div>
                    <div class="trend-item">
                        <div class="trend-label">对手合作后改为背叛</div>
                        <div class="trend-bar-container">
                            <div id="trend-cb" class="trend-bar" style="width: 0%"></div>
                        </div>
                        <div id="trend-cb-value" style="margin-left: 8px;">0%</div>
                    </div>
                    <div class="trend-item">
                        <div class="trend-label">对手背叛后继续背叛</div>
                        <div class="trend-bar-container">
                            <div id="trend-bb" class="trend-bar" style="width: 0%"></div>
                        </div>
                        <div id="trend-bb-value" style="margin-left: 8px;">0%</div>
                    </div>
                </div>
                
                <h2>游戏历史</h2>
                <div id="history" class="history"></div>
            </div>
            
            <div id="stats-tab" class="tab-content">
                <h2>玩家统计</h2>
                <button id="refresh-stats-button" class="join">刷新统计</button>
                <div id="player-stats">
                    <p>加载中...</p>
                </div>
            </div>
            
            <div id="leaderboard-tab" class="tab-content">
                <h2>排行榜</h2>
                <button id="refresh-leaderboard-button" class="join">刷新排行榜</button>
                <div id="leaderboard-container">
                    <table class="leaderboard">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>玩家名称</th>
                                <th>分数</th>
                                <th>游戏次数</th>
                                <th>当前回合</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <tr>
                                <td colspan="5">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let socket;
        let playerData = null;
        let currentOpponent = null;
        let gameInProgress = false;
        let opponentHistory = [];
        
        // DOM 元素
        const connectButton = document.getElementById('connect-button');
        const joinButton = document.getElementById('join-button');
        const cooperateButton = document.getElementById('cooperate-button');
        const betrayButton = document.getElementById('betray-button');
        const connectionStatus = document.getElementById('connection-status');
        const playerName = document.getElementById('player-name');
        const playerId = document.getElementById('player-id');
        const playerScore = document.getElementById('player-score');
        const currentRound = document.getElementById('current-round');
        const totalGames = document.getElementById('total-games');
        const opponentName = document.getElementById('opponent-name');
        const opponentId = document.getElementById('opponent-id');
        const gameStatus = document.getElementById('game-status');
        const historyContainer = document.getElementById('history');
        const errorMessage = document.getElementById('error-message');
        
        // 登录元素
        const loginContainer = document.getElementById('login-container');
        const gameContainer = document.getElementById('game-container');
        const playerNameInput = document.getElementById('player-name-input');
        const playerIdInput = document.getElementById('player-id-input');
        const loginButton = document.getElementById('login-button');
        
        // 标签页元素
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const refreshStatsButton = document.getElementById('refresh-stats-button');
        const refreshLeaderboardButton = document.getElementById('refresh-leaderboard-button');
        const playerStatsContainer = document.getElementById('player-stats');
        const leaderboardBody = document.getElementById('leaderboard-body');
        
        // 奖励机制元素
        const bothCooperateSpan = document.getElementById('both-cooperate');
        const bothBetraySpan = document.getElementById('both-betray');
        const cooperateSpan = document.getElementById('cooperate');
        const betraySpan = document.getElementById('betray');
        
        // WebSocket连接状态元素
        const connectionDetails = document.getElementById('connection-details');
        const connectionId = document.getElementById('connection-id');
        const transportType = document.getElementById('transport-type');
        const pingTime = document.getElementById('ping-time');
        const pingQuality = document.getElementById('ping-quality');
        const connectionTime = document.getElementById('connection-time');
        
        // WebSocket连接时间
        let connectionStartTime = null;
        let pingInterval = null;
        
        // 更新连接时间
        function updateConnectionTime() {
            if (!connectionStartTime) return;
            
            const now = new Date();
            const diff = now - connectionStartTime;
            const seconds = Math.floor(diff / 1000) % 60;
            const minutes = Math.floor(diff / (1000 * 60)) % 60;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            
            connectionTime.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // 测量WebSocket延迟
        function measurePing() {
            if (!socket || !socket.connected) return;
            
            const start = Date.now();
            socket.emit('ping', null, () => {
                const duration = Date.now() - start;
                pingTime.textContent = `${duration}ms`;
                
                // 设置延迟质量指示
                pingQuality.className = 'ping-info';
                if (duration < 100) {
                    pingQuality.classList.add('ping-good');
                    pingQuality.textContent = '良好';
                } else if (duration < 300) {
                    pingQuality.classList.add('ping-medium');
                    pingQuality.textContent = '一般';
                } else {
                    pingQuality.classList.add('ping-bad');
                    pingQuality.textContent = '较差';
                }
            });
        }
        
        // 显示错误信息
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            
            // 5秒后自动隐藏
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
        
        // 重置游戏按钮状态
        function resetGameButtons() {
            cooperateButton.disabled = true;
            betrayButton.disabled = true;
        }
        
        // 标签页切换
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // 移除所有标签页的active类
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // 给当前标签页添加active类
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                
                // 如果切换到排行榜标签，自动刷新排行榜
                if (tabId === 'leaderboard-tab' && socket && socket.connected) {
                    socket.emit('getLeaderboard');
                }
                
                // 如果切换到统计标签，自动刷新统计
                if (tabId === 'stats-tab' && socket && socket.connected) {
                    socket.emit('getPlayerStats');
                }
            });
        });
        
        // 连接服务器
        connectButton.addEventListener('click', function() {
            if (!socket) {
                try {
                    socket = io('http://localhost:3000', {
                        transports: ['websocket'], // 强制使用WebSocket
                        upgrade: false, // 禁止协议升级
                        reconnectionAttempts: 5, // 重连次数
                        timeout: 10000 // 连接超时时间
                    });
                    
                    // 连接事件处理
                    socket.on('connect', function() {
                        connectionStatus.className = 'status connected';
                        connectionStatus.textContent = '已连接 (WebSocket)';
                        connectButton.textContent = '断开连接';
                        
                        // 更新连接详情
                        connectionDetails.style.display = 'block';
                        connectionId.textContent = socket.id;
                        transportType.textContent = socket.io.engine.transport.name;
                        connectionStartTime = new Date();
                        
                        // 开始定时更新连接时间和测量延迟
                        clearInterval(pingInterval);
                        pingInterval = setInterval(() => {
                            updateConnectionTime();
                            measurePing();
                        }, 1000);
                        
                        // 显示登录界面
                        loginContainer.style.display = 'block';
                        
                        addHistoryItem('系统', '已通过WebSocket连接到服务器');
                    });
                    
                    // WebSocket特定错误
                    socket.on('connect_error', function(error) {
                        showError('WebSocket连接错误: ' + error.message);
                        addHistoryItem('错误', 'WebSocket连接失败');
                        
                        // 尝试回退到HTTP轮询（仅用于开发测试，生产环境可以移除）
                        if (socket.io.opts.transports.indexOf('polling') === -1) {
                            addHistoryItem('系统', '尝试回退到HTTP轮询...');
                            socket.io.opts.transports = ['polling', 'websocket'];
                            socket.connect();
                        }
                    });
                    
                    // 断开连接事件处理
                    socket.on('disconnect', function(reason) {
                        connectionStatus.className = 'status disconnected';
                        connectionStatus.textContent = '已断开连接';
                        connectButton.textContent = '连接服务器';
                        resetGameButtons();
                        gameStatus.textContent = '未开始';
                        
                        // 清理连接状态
                        connectionDetails.style.display = 'none';
                        connectionStartTime = null;
                        clearInterval(pingInterval);
                        
                        // 隐藏游戏界面
                        loginContainer.style.display = 'none';
                        gameContainer.style.display = 'none';
                        
                        // 记录断开原因
                        const reasonMsg = {
                            'io server disconnect': '服务器主动断开连接',
                            'io client disconnect': '客户端主动断开连接',
                            'ping timeout': '心跳检测超时',
                            'transport close': '传输层关闭',
                            'transport error': '传输层错误'
                        }[reason] || `未知原因 (${reason})`;
                        
                        addHistoryItem('系统', `WebSocket连接断开: ${reasonMsg}`);
                        
                        // WebSocket特定的自动重连逻辑
                        if (reason === 'ping timeout' || reason === 'transport error') {
                            addHistoryItem('系统', '尝试重新连接...');
                            
                            // 仅当不是用户主动断开时才重连
                            if (playerData) {
                                setTimeout(() => {
                                    if (!socket.connected) {
                                        socket.connect();
                                        
                                        // 如果有存储的玩家ID，自动登录
                                        socket.once('connect', () => {
                                            const savedId = localStorage.getItem('playerId');
                                            const savedName = localStorage.getItem('playerName');
                                            
                                            if (savedId && savedName) {
                                                addHistoryItem('系统', '尝试使用已保存的ID自动登录...');
                                                socket.emit('login', {
                                                    playerName: savedName,
                                                    playerId: savedId
                                                });
                                            }
                                        });
                                    }
                                }, 3000);
                            }
                        }
                        
                        playerData = null;
                        currentOpponent = null;
                        gameInProgress = false;
                    });
                    
                    // 添加重连尝试事件
                    socket.io.on('reconnect_attempt', (attempt) => {
                        addHistoryItem('系统', `尝试第 ${attempt} 次重新连接...`);
                    });
                    
                    socket.io.on('reconnect', () => {
                        addHistoryItem('系统', '重新连接成功!');
                    });
                    
                    socket.io.on('reconnect_error', (error) => {
                        addHistoryItem('错误', `重新连接失败: ${error.message}`);
                    });
                    
                    socket.io.on('reconnect_failed', () => {
                        addHistoryItem('系统', '重新连接失败，已达到最大尝试次数');
                        showError('重新连接失败，请手动刷新页面');
                    });
                    
                    // 登录成功事件处理
                    socket.on('loginSuccess', function(data) {
                        playerData = data.playerData;
                        
                        // 更新玩家信息
                        playerName.textContent = playerData.name;
                        playerId.textContent = playerData.id;
                        playerScore.textContent = playerData.score;
                        currentRound.textContent = playerData.currentRound;
                        totalGames.textContent = playerData.totalGames;
                        
                        // 保存玩家ID到localStorage
                        localStorage.setItem('playerName', playerData.name);
                        localStorage.setItem('playerId', playerData.id);
                        
                        // 显示游戏界面
                        loginContainer.style.display = 'none';
                        gameContainer.style.display = 'block';
                        
                        addHistoryItem('系统', data.isNewPlayer ? '注册成功，欢迎新玩家!' : '登录成功，欢迎回来!');
                        
                        // 获取排行榜和统计
                        socket.emit('getLeaderboard');
                        socket.emit('getPlayerStats');
                    });
                    
                    // 游戏加入确认事件处理
                    socket.on('gameJoined', function(data) {
                        playerData = data.playerData;
                        updatePlayerInfo();
                        updateRewardInfo(data.globalRewards);
                        
                        joinButton.disabled = true;
                        gameStatus.textContent = '等待匹配';
                        addHistoryItem('系统', '已加入游戏，等待匹配对手');
                    });
                    
                    // 匹配成功事件处理
                    socket.on('matchFound', function(data) {
                        currentOpponent = data.opponent;
                        gameInProgress = true;
                        
                        opponentId.textContent = currentOpponent;
                        opponentName.textContent = data.opponentName || '未知对手';
                        gameStatus.textContent = '已匹配，请做出选择';
                        cooperateButton.disabled = false;
                        betrayButton.disabled = false;
                        
                        // 处理对手历史
                        opponentHistory = data.opponentHistory || [];
                        analyzeOpponentHistory(opponentHistory);
                        
                        // 显示对手分析面板
                        document.getElementById('opponent-analysis').style.display = 'block';
                        
                        addHistoryItem('系统', `已匹配到对手: ${data.opponentName || '未知对手'}`);
                    });
                    
                    // 回合完成事件处理
                    socket.on('roundComplete', function(data) {
                        playerData.score = data.totalScore;
                        playerData.currentRound++;
                        
                        updatePlayerInfo();
                        gameStatus.textContent = '回合结束，等待匹配新对手';
                        resetGameButtons();
                        
                        const roundResult = `回合结束: 你${data.score >= 0 ? '获得' : '失去'}了 ${Math.abs(data.score)} 分，对手 ${data.opponentName} 选择了 ${data.opponentChoice === 'cooperate' ? '合作' : '背叛'}`;
                        addHistoryItem('游戏', roundResult);
                        
                        // 重置对手
                        currentOpponent = null;
                        opponentId.textContent = '-';
                        opponentName.textContent = '等待匹配';
                        
                        // 隐藏对手分析面板
                        document.getElementById('opponent-analysis').style.display = 'none';
                        opponentHistory = [];
                        
                        // 刷新统计数据
                        socket.emit('getPlayerStats');
                        socket.emit('getLeaderboard');
                    });
                    
                    // 游戏结束事件处理
                    socket.on('gameEnd', function(data) {
                        gameStatus.textContent = '游戏结束';
                        resetGameButtons();
                        gameInProgress = false;
                        joinButton.disabled = false; // 允许重新加入
                        
                        addHistoryItem('系统', `游戏结束，最终分数: ${data.finalScore}，总回合: ${data.rounds}，${data.message}`);
                        
                        // 刷新统计数据和排行榜
                        socket.emit('getPlayerStats');
                        socket.emit('getLeaderboard');
                    });
                    
                    // 对手断开连接事件处理
                    socket.on('opponentDisconnected', function(data) {
                        gameStatus.textContent = '等待匹配';
                        resetGameButtons();
                        currentOpponent = null;
                        opponentId.textContent = '-';
                        opponentName.textContent = '无对手';
                        
                        addHistoryItem('系统', data.message);
                    });
                    
                    // 排行榜数据事件处理
                    socket.on('leaderboardData', function(data) {
                        updateLeaderboard(data.leaderboard);
                    });
                    
                    // 玩家统计数据事件处理
                    socket.on('playerStats', function(data) {
                        updatePlayerStats(data.stats);
                    });
                    
                    // 错误事件处理
                    socket.on('error', function(data) {
                        showError(data.message);
                        addHistoryItem('错误', data.message);
                    });
                } catch (error) {
                    showError('初始化Socket连接失败: ' + error.message);
                }
            } else {
                socket.disconnect();
                socket = null;
            }
        });
        
        // 登录/注册
        loginButton.addEventListener('click', function() {
            if (socket && socket.connected) {
                const name = playerNameInput.value.trim();
                const id = playerIdInput.value.trim();
                
                if (!name) {
                    showError('请输入玩家名称');
                    return;
                }
                joinButton.disabled = false;
                
                socket.emit('login', {
                    playerName: name,
                    playerId: id || undefined
                });
            }
        });
        
        // 加入游戏
        joinButton.addEventListener('click', function() {
            if (socket && socket.connected) {
                // 重置游戏状态
                gameInProgress = false;
                currentOpponent = null;
                resetGameButtons();
                
                socket.emit('joinGame');
                joinButton.disabled = true;
                opponentId.textContent = '-';
                opponentName.textContent = '等待匹配';
                gameStatus.textContent = '正在加入游戏...';
            }
        });
        
        // 选择合作
        cooperateButton.addEventListener('click', function() {
            if (socket && gameInProgress) {
                socket.emit('makeChoice', 'cooperate');
                cooperateButton.disabled = true;
                betrayButton.disabled = true;
                gameStatus.textContent = '已选择合作，等待结果';
                
                addHistoryItem('玩家', '你选择了合作');
            }
        });
        
        // 选择背叛
        betrayButton.addEventListener('click', function() {
            if (socket && gameInProgress) {
                socket.emit('makeChoice', 'betray');
                cooperateButton.disabled = true;
                betrayButton.disabled = true;
                gameStatus.textContent = '已选择背叛，等待结果';
                
                addHistoryItem('玩家', '你选择了背叛');
            }
        });
        
        // 刷新统计
        refreshStatsButton.addEventListener('click', function() {
            if (socket && socket.connected) {
                socket.emit('getPlayerStats');
            }
        });
        
        // 刷新排行榜
        refreshLeaderboardButton.addEventListener('click', function() {
            if (socket && socket.connected) {
                socket.emit('getLeaderboard');
            }
        });
        
        // 更新玩家信息
        function updatePlayerInfo() {
            if (playerData) {
                playerName.textContent = playerData.name;
                playerId.textContent = playerData.id;
                playerScore.textContent = playerData.score;
                currentRound.textContent = playerData.currentRound;
                totalGames.textContent = playerData.totalGames;
            }
        }
        
        // 更新奖励信息
        function updateRewardInfo(rewards) {
            if (rewards) {
                bothCooperateSpan.textContent = rewards.bothCooperate;
                bothBetraySpan.textContent = rewards.bothBetray;
                cooperateSpan.textContent = rewards.cooperate;
                betraySpan.textContent = rewards.betray;
            }
        }
        
        // 更新排行榜
        function updateLeaderboard(leaderboard) {
            if (!leaderboard || !leaderboard.length) {
                leaderboardBody.innerHTML = '<tr><td colspan="4">暂无数据</td></tr>';
                return;
            }
            
            let html = '';
            leaderboard.forEach((player, index) => {
                html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${player.name || '匿名玩家'} ${(player.id && playerData && player.id === playerData.id) ? '(你)' : ''}</td>
                    <td>${player.score}</td>
                    <td>${player.totalGames || 0}</td>
                    <td>${player.currentRound || 0}</td>
                </tr>
                `;
            });
            
            leaderboardBody.innerHTML = html;
        }
        
        // 更新玩家统计
        function updatePlayerStats(stats) {
            if (!stats) {
                playerStatsContainer.innerHTML = '<p>暂无数据</p>';
                return;
            }
            
            const html = `
            <div>
                <p><strong>玩家名称:</strong> ${stats.name || '匿名玩家'}</p>
                <p><strong>ID:</strong> ${stats.id || '未知'}</p>
                <p><strong>当前分数:</strong> ${stats.score || 0}</p>
                <p><strong>游戏次数:</strong> ${stats.totalGames || 0}</p>
                <p><strong>当前回合:</strong> ${stats.currentRound || 0}</p>
                <p><strong>最后在线:</strong> ${formatDate(stats.lastSeen)}</p>
            </div>
            `;
            
            playerStatsContainer.innerHTML = html;
        }
        
        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '未知';
            
            const date = new Date(dateString);
            return date.toLocaleString();
        }
        
        // 添加历史记录
        function addHistoryItem(source, message) {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `<strong>${source}:</strong> ${message}`;
            historyContainer.appendChild(item);
            historyContainer.scrollTop = historyContainer.scrollHeight;
        }
        
        // 分析对手历史
        function analyzeOpponentHistory(history) {
            if (!history || !history.length) {
                console.log("没有对手历史数据可分析");
                return;
            }
            
            console.log("分析对手历史:", history);
            
            // 1. 计算基本统计数据
            let cooperateCount = 0;
            let betrayCount = 0;
            let maxCooperationStreak = 0;
            let maxBetrayalStreak = 0;
            let currentCooperationStreak = 0;
            let currentBetrayalStreak = 0;
            
            // 转换行为分析记录
            let behaviorsSimple = history.map(item => {
                // 支持旧格式(直接字符串)和新格式(对象里的choice字段)
                const choice = typeof item === 'string' ? item : item.choice;
                if (choice === 'cooperate') return 'c';
                if (choice === 'betray') return 'b';
                return null;
            }).filter(choice => choice !== null);
            
            // 统计合作和背叛数
            behaviorsSimple.forEach(choice => {
                if (choice === 'c') {
                    cooperateCount++;
                    currentCooperationStreak++;
                    currentBetrayalStreak = 0;
                    
                    if (currentCooperationStreak > maxCooperationStreak) {
                        maxCooperationStreak = currentCooperationStreak;
                    }
                } else {
                    betrayCount++;
                    currentBetrayalStreak++;
                    currentCooperationStreak = 0;
                    
                    if (currentBetrayalStreak > maxBetrayalStreak) {
                        maxBetrayalStreak = currentBetrayalStreak;
                    }
                }
            });
            
            // 计算合作率和背叛率
            const total = cooperateCount + betrayCount;
            const cooperationRate = total > 0 ? (cooperateCount / total * 100).toFixed(1) : 0;
            const betrayalRate = total > 0 ? (betrayCount / total * 100).toFixed(1) : 0;
            
            // 更新统计显示
            document.getElementById('cooperation-rate').textContent = `${cooperationRate}%`;
            document.getElementById('betrayal-rate').textContent = `${betrayalRate}%`;
            document.getElementById('max-cooperation-streak').textContent = maxCooperationStreak;
            document.getElementById('max-betrayal-streak').textContent = maxBetrayalStreak;
            
            // 2. 分析行为模式
            let ccCount = 0; // 合作后继续合作
            let cbCount = 0; // 合作后改为背叛
            let bcCount = 0; // 背叛后改为合作
            let bbCount = 0; // 背叛后继续背叛
            
            let afterCooperateCount = 0;
            let afterBetrayCount = 0;
            
            for (let i = 0; i < behaviorsSimple.length - 1; i++) {
                const current = behaviorsSimple[i];
                const next = behaviorsSimple[i + 1];
                
                if (current === 'c') {
                    afterCooperateCount++;
                    if (next === 'c') ccCount++;
                    else cbCount++;
                } else {
                    afterBetrayCount++;
                    if (next === 'c') bcCount++;
                    else bbCount++;
                }
            }
            
            // 计算百分比
            const ccRate = afterCooperateCount > 0 ? (ccCount / afterCooperateCount * 100).toFixed(1) : 0;
            const cbRate = afterCooperateCount > 0 ? (cbCount / afterCooperateCount * 100).toFixed(1) : 0;
            const bcRate = afterBetrayCount > 0 ? (bcCount / afterBetrayCount * 100).toFixed(1) : 0;
            const bbRate = afterBetrayCount > 0 ? (bbCount / afterBetrayCount * 100).toFixed(1) : 0;
            
            // 更新趋势显示
            document.getElementById('trend-cc').style.width = `${ccRate}%`;
            document.getElementById('trend-cc-value').textContent = `${ccRate}%`;
            
            document.getElementById('trend-cb').style.width = `${cbRate}%`;
            document.getElementById('trend-cb-value').textContent = `${cbRate}%`;
            
            document.getElementById('trend-bc').style.width = `${bcRate}%`;
            document.getElementById('trend-bc-value').textContent = `${bcRate}%`;
            
            document.getElementById('trend-bb').style.width = `${bbRate}%`;
            document.getElementById('trend-bb-value').textContent = `${bbRate}%`;
            
            // 3. 渲染历史图表
            // renderHistoryChart(behaviorsSimple);
            
            // 4. 分析奖励机制
            analyzeRewards(history);
            
            // 5. 渲染详细历史记录表格
            renderDetailedHistory(history);
            
            // 6. 生成高级分析图表
            // const hasRewards = history.some(item => typeof item === 'object' && item.rewards);
            // document.getElementById('advanced-analysis').style.display = hasRewards ? 'block' : 'none';
            
            // if (hasRewards) {
            //     renderAdvancedCharts(history);
            // }
        }
        
        // 渲染历史图表
        function renderHistoryChart(behaviors) {
            const chartContainer = document.getElementById('history-chart');
            chartContainer.innerHTML = '';
            
            if (!behaviors.length) {
                chartContainer.innerHTML = '<div style="text-align:center;padding-top:80px;color:#999;">暂无历史数据</div>';
                return;
            }
            
            const containerHeight = chartContainer.clientHeight;
            const barWidth = Math.min(10, Math.floor((chartContainer.clientWidth - 20) / behaviors.length));
            
            behaviors.forEach((behavior, index) => {
                const bar = document.createElement('div');
                bar.className = `bar ${behavior === 'c' ? 'cooperate' : 'betray'}`;
                bar.style.width = `${barWidth}px`;
                bar.style.height = `${containerHeight - 40}px`;
                
                // 添加鼠标悬停提示
                bar.title = `行为 ${index + 1}: ${behavior === 'c' ? '合作' : '背叛'}`;
                
                chartContainer.appendChild(bar);
            });
        }
        
        // 分析奖励机制
        function analyzeRewards(history) {
            // 只处理新格式的历史记录（包含rewards字段）
            const validHistory = history.filter(item => typeof item === 'object' && item.rewards);
            
            if (validHistory.length === 0) {
                document.getElementById('reward-both-cooperate').textContent = '-';
                document.getElementById('reward-both-betray').textContent = '-';
                document.getElementById('reward-cooperate').textContent = '-';
                document.getElementById('reward-betray').textContent = '-';
                return;
            }
            
            // 获取最新的奖励机制
            const latestRewards = validHistory[validHistory.length - 1].rewards;
            
            // 更新显示
            document.getElementById('reward-both-cooperate').textContent = latestRewards.bothCooperate;
            document.getElementById('reward-both-betray').textContent = latestRewards.bothBetray;
            document.getElementById('reward-cooperate').textContent = latestRewards.cooperate;
            document.getElementById('reward-betray').textContent = latestRewards.betray;
        }
        
        // 渲染详细历史记录表格
        function renderDetailedHistory(history) {
            const tableBody = document.getElementById('detailed-history-body');
            tableBody.innerHTML = '';
            
            if (!history || !history.length) {
                return;
            }
            
            // 过滤出对象类型的历史记录
            const validHistory = history.filter(item => typeof item === 'object');
            
            // 为表格创建行
            validHistory.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // 设置交替行的背景颜色
                if (index % 2 === 1) {
                    row.style.backgroundColor = '#f9f9f9';
                }
                
                // 格式化日期
                const date = item.timestamp ? new Date(item.timestamp) : null;
                const formattedDate = date ? date.toLocaleDateString() + ' ' + date.toLocaleTimeString().slice(0, 5) : '-';
                
                // 创建单元格内容
                row.innerHTML = `
                    <td style="padding: 6px; border-bottom: 1px solid #eee;">${item.round || index + 1}</td>
                    <td style="padding: 6px; border-bottom: 1px solid #eee;">
                        <span style="color: ${item.choice === 'cooperate' ? '#4CAF50' : '#F44336'};">
                            ${item.choice === 'cooperate' ? '合作' : '背叛'}
                        </span>
                    </td>
                    <td style="padding: 6px; border-bottom: 1px solid #eee;">${item.score || '-'}</td>
                    <td style="padding: 6px; border-bottom: 1px solid #eee;">${item.rewards ? item.rewards.bothCooperate : '-'}</td>
                    <td style="padding: 6px; border-bottom: 1px solid #eee;">${item.rewards ? item.rewards.bothBetray : '-'}</td>
                    <td style="padding: 6px; border-bottom: 1px solid #eee;">${item.rewards ? item.rewards.cooperate : '-'}</td>
                    <td style="padding: 6px; border-bottom: 1px solid #eee;">${item.rewards ? item.rewards.betray : '-'}</td>
                    <td style="padding: 6px; border-bottom: 1px solid #eee;">${formattedDate}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // 添加详细历史视图的切换事件
        document.getElementById('detailed-history-toggle').addEventListener('change', function() {
            const detailedContainer = document.getElementById('detailed-history-container');
            detailedContainer.style.display = this.checked ? 'block' : 'none';
        });
        
        // 渲染高级分析图表
        function renderAdvancedCharts(history) {
            // 筛选有效历史记录（包含rewards字段）
            const validHistory = history.filter(item => typeof item === 'object' && item.rewards);
            
            if (validHistory.length === 0) return;
            
            // 1. 选择分布饼图
            renderChoiceDistributionChart(validHistory);
            
            // 2. 奖励机制变化折线图
            renderRewardsChangeChart(validHistory);
            
            // 3. 奖励比例与选择关系图
            renderRewardsRatioChart(validHistory);
        }
        
        // 渲染选择分布饼图
        function renderChoiceDistributionChart(history) {
            const canvas = document.getElementById('choiceDistributionChart');
            
            // 统计选择
            let cooperateCount = 0;
            let betrayCount = 0;
            
            history.forEach(item => {
                if (item.choice === 'cooperate') {
                    cooperateCount++;
                } else if (item.choice === 'betray') {
                    betrayCount++;
                }
            });
            
            // 销毁旧图表
            if (window.choiceChart) {
                window.choiceChart.destroy();
            }
            
            // 创建新图表
            window.choiceChart = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels: ['合作', '背叛'],
                    datasets: [{
                        data: [cooperateCount, betrayCount],
                        backgroundColor: ['#4CAF50', '#F44336'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }
        
        // 渲染奖励机制变化折线图
        function renderRewardsChangeChart(history) {
            const canvas = document.getElementById('rewardsChangeChart');
            
            // 提取奖励数据点
            const rounds = [];
            const bothCooperateValues = [];
            const bothBetrayValues = [];
            const cooperateValues = [];
            const betrayValues = [];
            
            history.forEach((item, index) => {
                rounds.push(item.round || index + 1);
                bothCooperateValues.push(item.rewards.bothCooperate);
                bothBetrayValues.push(item.rewards.bothBetray);
                cooperateValues.push(item.rewards.cooperate);
                betrayValues.push(item.rewards.betray);
            });
            
            // 销毁旧图表
            if (window.rewardsChart) {
                window.rewardsChart.destroy();
            }
            
            // 创建新图表
            window.rewardsChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: rounds,
                    datasets: [
                        {
                            label: '双方合作各得',
                            data: bothCooperateValues,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: '双方背叛各得',
                            data: bothBetrayValues,
                            borderColor: '#F44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: '合作方损失',
                            data: cooperateValues,
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: '背叛方获得',
                            data: betrayValues,
                            borderColor: '#FF9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            title: {
                                display: true,
                                text: '轮次'
                            }
                        }
                    }
                }
            });
        }
        
        // 渲染奖励比例与选择关系图
        function renderRewardsRatioChart(history) {
            const canvas = document.getElementById('rewardsRatioChart');
            
            // 计算每个时间点的奖励比例和选择
            const data = [];
            
            for (let i = 0; i < history.length; i++) {
                const item = history[i];
                const rewards = item.rewards;
                
                // 计算背叛收益与合作收益比例
                const ratio = rewards.betray / rewards.bothCooperate;
                
                data.push({
                    round: item.round || i + 1,
                    ratio: ratio.toFixed(2),
                    choice: item.choice
                });
            }
            
            // 整理图表数据
            const rounds = data.map(d => d.round);
            const ratios = data.map(d => d.ratio);
            const choices = data.map(d => d.choice === 'cooperate' ? 1 : 0);
            
            // 销毁旧图表
            if (window.ratioChart) {
                window.ratioChart.destroy();
            }
            
            // 创建新图表
            window.ratioChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: rounds,
                    datasets: [
                        {
                            label: '背叛/合作收益比',
                            data: ratios,
                            backgroundColor: 'rgba(33, 150, 243, 0.5)',
                            borderColor: 'rgba(33, 150, 243, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: '选择（1=合作，0=背叛）',
                            data: choices,
                            type: 'line',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            pointRadius: 5,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '背叛/合作收益比'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: -0.1,
                            max: 1.1,
                            title: {
                                display: true,
                                text: '选择'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '轮次'
                            }
                        }
                    }
                }
            });
        }
        
        // 从localStorage加载玩家信息
        window.addEventListener('load', function() {
            const savedName = localStorage.getItem('playerName');
            const savedId = localStorage.getItem('playerId');
            
            if (savedName) {
                playerNameInput.value = savedName;
            }
            
            if (savedId) {
                playerIdInput.value = savedId;
            }
        });
    </script>
</body>
</html> 